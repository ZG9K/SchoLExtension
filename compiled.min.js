// 
// Random SchoL improvements that make it better maybe?
// by Zac McWilliam and Sebastien Taylor
//         ____
//   _,.-'`_ o `;__,
//    _.-'` '---'  '
//
// Dark mode made by Max Bentley, Yuma Soerianto, and Sebastien Taylor
//         _
//     ___(.)<
//     \____)
// 

const r=/\(([^)]+)\)/;const i=/\[([^)]+)\]/;const l=["Period 1","Period 2","Period 3","Period 4","Period 5"];const c=["(00","[00","(01","[01","(02","[02","(03","[03","(04","[04","(05","[05","(06","[06","(12","[12"];const d="https://apps.stmichaels.vic.edu.au/scholext";const s="/modules/remote/"+btoa("https://apps.stmichaels.vic.edu.au/scholext/auth")+"/window";const u="/storage/image.php?hash=82df5e189a863cb13e2e988daa1c7098ef4aa9e1";const D={t:"He/Him",o:"She/Her",i:"They/Them",l:"Ask Me"};const N=["image/png","image/gif","image/bmp","image/jpeg"];const j="https://services.stmichaels.vic.edu.au/_dmode/darkmode.css";const M={u:{},m:{},p:"light",g:{h:1,v:1},k:{selected:[],show:[1,1,1]},updated:0,version:2};let f=true;let A;let I;const U=.2126;const z=.7152;const V=.0722;const F=2.4;function m(e,t,o){var n=[e,t,o].map(e=>{e/=255;return e<=.03928?e/12.92:Math.pow((e+.055)/1.055,F)});return n[0]*U+n[1]*z+n[2]*V}function a(e,t){var o=m(...e);var n=m(...t);var a=Math.max(o,n);var i=Math.min(o,n);return(a+.05)/(i+.05)}let t;function o(){t=document.createElement("link");t.rel="stylesheet";t.href=j;document.styleSheets[1]&&(document.styleSheets[1].disabled=false);t.id="darkmode-core";(document.head||document.body).appendChild(t);t.onload=e=>{const o=[0,0,38];const n=4.5;document.querySelectorAll(`span:not([style*="color:#000"]):not(td[style*="background-color"] span):not(span[style*="background-color"] > span):not(div[style*="background-color"] *)`).forEach(e=>{let t=window.getComputedStyle(e).color.replace(/[^\d,]/g,"").split(",").slice(0,3);if(t.length===3&&a(o,t)<n){e.style.color=`rgb(${255-t[0]},${255-t[1]},${255-t[2]})`}});document.querySelectorAll(`span[style*="background-color"]`).forEach(e=>{let t=window.getComputedStyle(e).color.replace(/[^\d,]/g,"").split(",").slice(0,3);let o=window.getComputedStyle(e).backgroundColor.replace(/[^\d,]/g,"").split(",").slice(0,3);if(t.length===3&&a(o,t)<n){e.style.cssText+=`color:rgb(${255-t[0]},${255-t[1]},${255-t[2]}) !important;`}});document.querySelectorAll(`*[style*="color"]`).forEach(e=>{let t=window.getComputedStyle(e).color.replace(/[^\d,]/g,"").split(",").slice(0,3);let o=window.getComputedStyle(e).backgroundColor.replace(/[^\d,]/g,"").split(",").slice(0,3);if(t.length===3&&a(o,t)<n){e.style.cssText+=`color:rgb(${255-t[0]},${255-t[1]},${255-t[2]}) !important;`}})}}async function p(e){if(t){t.remove();t=undefined}switch(e){case"dark":o();break;case"defaults":if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches){o()}break;case"light":break;default:I.p=M.p;I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));await _()}}if(!(localStorage.getItem("disableQOL")!=undefined&&typeof forceEnableQOL=="undefined")&&localStorage.getItem("extConfig")!==null){try{let e=JSON.parse(localStorage.getItem("extConfig"));if(e.p)p(e.p)}catch{console.log("2345312")}}if(document.readyState==="complete"||document.readyState==="interactive"){n()}else{window.addEventListener("DOMContentLoaded",()=>{n()})}async function n(){if(localStorage.getItem("disableQOL")!=undefined&&typeof forceEnableQOL=="undefined")return;if(typeof schoolboxUser=="undefined")return;if(schoolboxUser.id!=localStorage.getItem("lastUser")){localStorage.removeItem("extConfig");localStorage.removeItem("lastThemeCache");localStorage.removeItem("userToken");localStorage.setItem("lastUser",schoolboxUser.id)}let e=false;if(localStorage.getItem("skipServerLoading")!==null){if(localStorage.getItem("skipServerLoading")>Date.now()){e=true}else{localStorage.removeItem("skipServerLoading")}(async()=>{try{await T();console.warn("[SCHOLEXT] Server is back online! Everything will be loaded as normal with the next page load.");localStorage.removeItem("skipServerLoading")}catch(e){if(e.message==="Network error"){console.warn(`[SCHOLEXT] Server is still offline, skipping forced server loading for ${Math.round((localStorage.getItem("skipServerLoading")-Date.now())/1e3/60)} minutes`)}}})()}let t={updated:0,version:M.version};if(!e){try{t=await T()}catch(o){e=true;if(o.message==="Forbidden"){console.error("[SCHOLEXT] Access to configuration data is forbidden. This is likely due to an invalid JWT. We will try to generate a new one,");localStorage.removeItem("userToken");await S();try{t=await T();e=false}catch(o){console.error("[SCHOLEXT] Failed to fetch configuration data after re-authentication. Something is very wrong",o)}}else if(o.message==="Network error"){console.error("[SCHOLEXT] Could not reach the server. It is possible that the server is down. Will still attempt to load configuration data from local storage.")}else{console.error("[SCHOLEXT] An unknown error occurred while fetching configuration data.")}}}if(M.version!=t.version){console.log("Version Mismatch");return}if(e){if(localStorage.getItem("extConfig")!==null){try{I=JSON.parse(localStorage.getItem("extConfig"))}catch{localStorage.removeItem("extConfig");return}}else{console.error("[SCHOLEXT] No configuration data could be loaded. Server is likely down and no local configuration data exists. Please try again later.");return}console.warn("[SCHOLEXT] Loaded configuration data from local storage. We were unable to reach the server to fetch the latest configuration data so this may be out of date.");console.warn("[SCHOLEXT] It is possible that some functionality will not work as intended until the server is back online.");console.warn("[SCHOLEXT] If you are seeing this message frequently, please contact the SchoL Extension team.");if(!localStorage.getItem("skipServerLoading")){localStorage.setItem("skipServerLoading",Date.now()+18e5);document.body.insertAdjacentHTML("beforeend",`<div id="scholext-fail-toaster" class="toast alert" data-toast></div>`);const n=$("#scholext-fail-toaster");n.S({text:"Could not connect to SchoL Extension server. Custom timetable colours may not work correctly",T:"alert"})}}else if(localStorage.getItem("extConfig")!==null){try{I=JSON.parse(localStorage.getItem("extConfig"))}catch{localStorage.removeItem("extConfig");return}if(I.updated<t.updated){I=t;localStorage.setItem("extConfig",JSON.stringify(I))}}else if(t.updated!==0){I=t;localStorage.setItem("extConfig",JSON.stringify(I))}else{I=M;await P(true)}if(!localStorage.getItem("lastThemeCache")||localStorage.getItem("lastThemeCache")&&Date.now()-parseInt(localStorage.getItem("lastThemeCache"))>864e5||I.m=={}){await P()}R();if(window.location.pathname=="/")K();if(window.location.pathname=="/learning/classes")B();if(window.location.pathname.startsWith("/calendar"))setInterval(Y,500);if(window.location.pathname.startsWith("/learning/due"))setInterval(q,500);if(window.location.pathname.startsWith("/learning/grades"))Z();if(window.location.pathname.startsWith("/learning/assessments/"))G();if(window.location.pathname.startsWith("/timetable"))ee();if(window.location.pathname.startsWith("/search/user"))Q();if(window.location.pathname.startsWith("/search/user/")&&window.location.pathname.endsWith(schoolboxUser.id))await x();if(window.location.pathname.startsWith("/settings/messages"))await x()}async function P(l){return new Promise(async s=>{await S();fetch("/timetable").then(e=>e.text()).then(e=>{let t=Object.assign({},I.u)||{};let o={};let n=new DOMParser;const a=n.parseFromString(e,"text/html");for(const i of a.querySelectorAll(".timetable-subject[style*='background-color'] div")){if(!r.exec(i.innerText))continue;o[r.exec(i.innerText)[1]]={color:i.parentNode.style.backgroundColor,$:null,current:"color"}}for(const i in o){if(t[i]===undefined){t[i]=o[i]}}for(const i in t){if(o[i]===undefined){delete t[i]}}localStorage.setItem("lastThemeCache",Date.now());if(JSON.stringify(I.u)!=JSON.stringify(t)||JSON.stringify(I.m)!=JSON.stringify(o)||l){I.u=t;I.m=o;I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));_().then(e=>s())}else{s()}})})}window.Clipboard=function(t,o,n){var a,e,i,s;e=function(e){a=o.createElement("textArea");a.value=e;o.body.appendChild(a);if(n.userAgent.match(/ipad|iphone/i)){i=o.createRange();i.selectNodeContents(a);s=t.getSelection();s.removeAllRanges();s.addRange(i);a.setSelectionRange(0,999999)}else{a.select()}o.execCommand("copy");o.body.removeChild(a)};return{C:e}}(window,document,navigator);function L(e,t,o){return"#"+((1<<24)+(e<<16)+(t<<8)+o).toString(16).slice(1)}function E(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(t){var o=parseInt(t[1],16);var n=parseInt(t[2],16);var a=parseInt(t[3],16);return o+", "+n+", "+a}return null}function g(e){return parseInt(e,16)||e}function h(e){return g(e)/255<=.03928?g(e)/255/12.92:Math.pow((g(e)/255+.055)/1.055,2.4)}function b(e){return.2126*h(e.substr(1,2))+.7152*h(e.substr(3,2))+.0722*h(e.substr(-2))}function w(e,t){const o=b(e);const n=b(t);return(Math.max(o,n)+.25)/(Math.min(o,n)+.25)}function v(e){const t=w(e,"#ffffff");const o=w(e,"#000000");return t>o?"#ffffff":"#000000"}function X(e){const t=[...e.matchAll(/(?:[0-9a-fA-F]{6})/g)];let o=[];for(const n of t){const a=E(n);if(!a)continue;o.push(`rgb(${a})`)}return o}async function R(){if(document.getElementById("message-list").children[1]){const n=document.createElement("input");n.placeholder="Type to search";n.addEventListener("keyup",()=>{if(document.activeElement===n){const e=n.value.toLowerCase();const t=document.getElementById("msg-content").querySelectorAll("li");for(const o of t){if(o.textContent.toLocaleLowerCase().trim().indexOf(e)==-1){o.style.display="none"}else{o.style.display="block"}}}});document.getElementById("message-list").children[1].appendChild(n)}for(let e of document.querySelectorAll("time")){if(e.textContent.includes("remaining")){const t=(new Date(e.dateTime).getTime()-Date.now())/864e5;const o=(new Date(e.dateTime).getTime()-Date.now())/36e5;const a=(new Date(e.dateTime).getTime()-Date.now())/6e4;if(t>=1){e.textContent=Math.round(t)+(t==1?" day left":" days left")}else if(o>=1){e.textContent=Math.round(o)+(o==1?" hour left":" hours left")}else{e.textContent=Math.round(a)+(a==1?" minute left":" minutes left")}}}document.querySelector("#profile-options .icon-staff-students").insertAdjacentHTML("afterend",`<li><a href="/timetable" class="icon-timetable">Timetable</a></li>`);if(!I.p){I.p=M.p;I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));await _()}p(I.p);J();W();y();setTimeout(y,1e3)}function J(){for(const t of document.querySelectorAll("#side-menu-mysubjects li a")){let e=I.u[t.href.split("/")[t.href.split("/").length-1]];if(!e?.color)continue;t.style.backgroundColor=e.color.replace("rgb","rgba").replace(")",", 10%)");t.style.borderLeft="7px solid "+e.color}}function y(){if(I.g.h){let e=document.querySelectorAll(".Schoolbox_Learning_Component_Dashboard_UpcomingWorkController li");if(!e.length){e=document.querySelectorAll("#report_content li")}for(const t of e){const o=r.exec(t.querySelector("a:not(.title)").innerText)[1]?.split(",");for(const n of o){const a=I.u[n]?.color;if(!a)continue;t.style.backgroundColor=a.replace("rgb","rgba").replace(")",", 10%)");t.style.borderLeft="10px solid "+a}}}}function W(){for(const e of document.querySelectorAll(".timetable-subject[style*='background-color'] div, .timetable-subject[style*='background'] div, .show-for-small-only tr td .timetable-subject div")){if(!r.exec(e.textContent))continue;const t=r.exec(e.innerText)[1].split(",");for(const o of t){const n=I.u[o];if(!n?.color)continue;const a=v(L(...n["color"].replace(/[^\d\s]/g,"").split(" ").map(Number)).toUpperCase());e.parentNode.style.backgroundColor=n["color"];e.parentNode.style.color=a;e.parentNode.querySelectorAll("*:not(a)").forEach(e=>{e.style.color=a});if(a!="#000000")e.parentNode.querySelectorAll("a").forEach(e=>e.style.color="#b0e1ff");if(n.current=="image"&&n.$){e.parentNode.style.backgroundImage="url("+n.$+")";e.parentNode.style.backgroundSize=`100% 100%`}}}}function B(){const e=document.querySelectorAll("div.v-card");for(const t of e){for(const o of t.querySelector("p.meta").innerText.split("\n")[0].split(",")){const n=I.u[o]?.color;if(!n)continue;t.querySelector("div.card-class-image").style.borderBottom=`10px solid ${n}`}}}function Q(){fetch(d+"/pronouns/"+window.location.pathname.split("/")[window.location.pathname.split("/").length-1],{headers:new Headers({O:"Basic "+localStorage.getItem("userToken")})}).then(e=>e.json()).then(e=>{let t=e.join(", ");const o=document.querySelector(".main .profile.content .row");o.style.position="relative";o.insertAdjacentHTML("beforeend",`<span class="neutral label hide-for-small-down" style="position: absolute; top: 0; right: 0; margin: 0${!t.length?"; display: none !important":""}" id="pronounslabel">Pronouns: ${t}</span>`);o.children[1].insertAdjacentHTML("beforeend",`<dl class="hide-for-medium-up" ${!t.length?"style='display: none !important'":""}><dt class="small-4 medium-3 columns">Pronouns:</dt><dd class="small-8 medium-9 columns" id="pronounsrow">${t}</dd></dl>`)})}async function x(){let e="";for(const v in I.u){const y=I.u[v].color;const x=L(...y.replace(/[^\d\s]/g,"").split(" ").map(Number));e+=`<tr role="row" class="subject-color-row" style="background-color: ${y.replace("rgb","rgba").replace(")",", 10%)")}; ${I.u[v].current==="image"?"background-image: url("+I.u[v].$+");":""} background-size: 100% 100%; border-left: 7px solid ${y}">
            <td>${v}</td>
            <td>
                <div id="image-uploader">
                    <input type="color" style="display: ${I.u[v].current==="image"?"none":""}" value="${x}">
                    <input type="url" class="image-drop-zone"pattern="https://.*" required placeholder="Drag Image Here" style="display: ${I.u[v].current==="image"?"":"none"}" value="${I.u[v]["$"]===null?"":I.u[v].$}">
                    <p style="display: none; color: red" class="invalidurl">Not a valid URL</p>
                </div>
            </td>
            <td style="text-align: center">
                <a id="settingsresset" data-target="delete" data-state="closed" class="icon-refresh" title="Reset" style="vertical-align: middle; line-height: 40px"></a>
            </td>
            <td style="text-align: center">
                <a data-target="delete" style="vertical-align: middle; line-height: 39px; display: ${I.u[v].current==="image"?"none":""}" data-state="closed" class="icon-image" title="Image">
                <a data-target="delete" style="vertical-align: middle; line-height: 39px; display: ${I.u[v].current==="image"?"":"none"}" data-state="closed" class="icon-drag-drop" title="Colour">
            </td>
        </tr>`}if(Object.keys(I.u).length<1){e+=`<tr role="row" class="subject-color-row">
            <td colspan="3">There are no timetable subjects associated with your account</td>
        </tr>`}const t=[{value:"defaults",label:"System Defaults"},{value:"light",label:"Light"},{value:"dark",label:"Dark"}];function o(e){let t='<option disabled="" selected="">Click to select a theme</option>';e.forEach(e=>{t+=`<option value="${e.value}">${e.label}</option>`});return t}const n=o(t);let a="";const i=await oe();if(i){a+=`<option disabled selected>Click to select a theme</option>`;for(const k of i){a+=`<option ${localStorage.getItem("currentTheme")===k.name?"selected":""} value='${k.u}'>${k.name}</option>`}}const s={h:["Coloured Due Work","Add colours to due work items based on the timetable"],v:["Compact Timetable","Remove empty items/rows from the timetable on the dashboard and timetable page"]};let l="";for(const S in s){l+=`<tr>
            <td style="border-bottom: 0px !important"><label for="toggle_${S}">${s[S][0]}<p>${s[S][1]}</p></label></td>
            <td style="border-bottom: 0px !important">
                <div class="long switch no-margin" style="float: right">
                    <input id="toggle_${S}" type="checkbox" name="toggle_${S}" value="1" checked>
                    <label for="toggle_${S}">
                        <span>Enabled</span>
                        <span>Disabled</span>
                    </label>
                </div>
            </td>
        </tr>`}const r=window.location.pathname.startsWith("/search/user");let c;if(r){c=document.querySelectorAll("#content .row");if(!c[3]){c=c[1]}else{c=c[3]}c.querySelector("div").classList="medium-12 large-6 island";c.querySelector("div").insertAdjacentHTML("afterbegin",`<h2 class="subheader">Profile</h2>`)}else{c=document.querySelector("#msg-settings");c.insertAdjacentHTML("beforebegin",`<div class="row"><div class="medium-12 large-6 island" id="msg-settings-wrapper"></div></div>`);document.getElementById("msg-settings-wrapper").appendChild(c);c=c.parentNode}c.insertAdjacentHTML(r?"beforeend":"afterend",`<div class="medium-12 large-6 island">
            <h2 class="subheader">Preferred Pronouns</h2>
            <section>
                <fieldset class="content">
                    <legend><strong>Preferred Pronouns</strong></legend>
                    <div class="small-12 columns">
                        <p>St Michael's is committed to ensuring that we have safe and inclusive learning environments and in keeping with our values, that we respect and acknowledge the diversity of our community. We have therefore provided the option for students and staff to choose their pronouns on SchoL - noting that this is not currrently reflected on School records nor an official notification to the School. There is no expectation or requirement for students or staff to select their pronouns.</p>
                    </div>
                    <div class="small-12 medium-6 columns">
                        <fieldset class="content">
                            <label>Select Pronouns
                                <div class="checklist checklist-container" id="pronoun-list">
                                    <input id="checkbox-pronoun1" type="checkbox" name="theythem"><label for="checkbox-pronoun1">They/Them</label>
                                    <input id="checkbox-pronoun2" type="checkbox" name="hehim"><label for="checkbox-pronoun2">He/Him</label>
                                    <input id="checkbox-pronoun3" type="checkbox" name="sheher"><label for="checkbox-pronoun3">She/Her</label>
                                    <input id="checkbox-pronoun4" type="checkbox" name="other"><label for="checkbox-pronoun4">Other (Ask Me)</label>
                                </div>
                            </label>
                        </fieldset>
                    </div>
                    <div class="small-12 medium-6 columns">
                        <fieldset class="content">
                            <label>Select roles to show your pronouns to
                                <div class="checklist checklist-container" id="pronoun-roles">
                                    <input id="checkbox-roles1" type="checkbox" name="0"><label for="checkbox-roles1">Students</label>
                                    <input id="checkbox-roles2" type="checkbox" name="1"><label for="checkbox-roles2">Staff/Teachers</label>
                                    <input id="checkbox-roles3" type="checkbox" name="2"><label for="checkbox-roles3">Parents</label>
                                </div>
                            </label>
                        </fieldset>
                    </div>
                    <div class="small-12 columns">
                        <p class="meta"><strong>Note: </strong>To make official changes of names to a student's records, there is a process that parents need to follow by contacting the Head of the School.</p>
                    </div>
                </fieldset>
            </section>
            <h2 class="subheader">Timetable Theme</h2>
            <table class="dataTable no-footer" role="grid">
                <thead>
                    <tr role="row">
                        <th style="width: 1000px">Subject</th>
                        <th style="width: 200px">Pick Theme</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>${e}</tbody>
            </table>

            <h2 class="subheader">Theme Manager</h2>
            <section>
                <fieldset class="content">
                    <legend><strong>Theme Import/Export</strong></legend>
                    <div class="small-12 columns">
                        <p>Import a theme (list of hex codes seperated by dashes), this also supports URLs from <a target="_blank" href="https://coolors.co/d9ed92-b5e48c-99d98c-76c893-52b69a-34a0a4-168aad-1a759f-1e6091-184e77">coolors.co</a></p>
                    </div>
                    <div class="small-12 columns">
                        <div class="input-group">
                            <input type="text" id="importtext" placeholder="Hex codes seperated by dashes (#FDFD96-#22AA66...) or https://coolors.co/ link">
                            <a class="button disabled" id="importbtn">Import</a>
                        </div>
                    </div>
                    <div class="small-12 columns"><p>Export your current theme to share it with friends!</p></div>
                    <div class="small-12 columns"><div class="input-group"><input type="text" id="currenttheme" readonly><a class="button" id="exportbtn">Export</a></div></div>
                    <div class="small-12 columns"><p>Or choose a premade theme!</p></div>
                    <div class="small-12 columns"><select id="context-selector-themes">${a}</select></div>
                </fieldset>
                <fieldset class="content">
                    <legend><strong>Settings</strong></legend>
                    <div class="small-12 columns">
                        <table class="no-margin"><tbody>${l}</tbody></table>
                    </div>
                </fieldset>
                <div class="component-action">
                    <section>
                        <a class="button" style="color: #ff5555;" id="resetbtn">Reset</a>
                    </section>
                </div>
            </section>

            <div id=customStuff>
            </div>

            <div class="component-action" style="margin-top: 20px; margin-bottom: 20px;">
                <span style="font-size: 12px; color: #AAA;">
                    Additional features developed by Yuma (11M), Sebastien (12H), Max (11S), and Zac (OM2022).
                </span>
            </div>

            <ul class="meta" style="font-size: 12px">
                SchoL features and profile settings are managed by the School Leadership Team and the St Michael's ICT Steering Committee. Feedback and future suggestions for the improvement of SchoL can be directed to: <a href="mailto:scholfeedback@stmichaels.vic.edu.au">scholfeedback@stmichaels.vic.edu.au</a>. <!-- rip dead name remover :( -->
            </ul>
        </div>`);module_darkMode=`  
        <h2 class="subheader">Dark Mode</h2>
        <section>
            <fieldset class="content">
                <legend><strong>Dark Mode Theme Selector</strong></legend>
                <div class="small-12 columns">
                    <p>Select your SchoL Theme Here! 'System Defaults' uses your system theme setting, while light and dark mode override that setting for your preference.<br></p>
                </div>
                <div class="small-12 columns" style="margin-top:10px;"><select id="context-selector-dark">${n}</select></div>
                <div class="small-12 columns">
                    <p class="meta"><strong>Note:</strong> Not all text on SchoL will be compatible with dark mode, due to overridden custom formatting added to news/blog posts.</p>
                </div>
            </fieldset>
        </section>
        `;function d(e){var t=document.getElementById("customStuff");t.innerHTML+=e}d(module_darkMode);document.querySelector("#context-selector-dark").value=I.p;document.querySelector("#context-selector-dark").addEventListener("change",async function(){I.p=this.value;I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));await _();window.location.reload()});for(const S in s){const T=document.getElementById("toggle_"+S);if(I.g[S]){T.setAttribute("checked",1)}else{T.removeAttribute("checked",1)}T.addEventListener("change",async function(){I.g[S]=T.checked;I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));await _()})}let u=document.getElementById("image-uploader");let f=document.getElementById("resetbtn");let m=document.getElementById("currenttheme");let p=document.getElementById("importtext");let g=document.getElementById("importbtn");let h=document.getElementById("exportbtn");let b=document.getElementById("context-selector-themes");document.addEventListener("drop",async function(o){if(!o.target.classList.contains("image-drop-zone"))return;o.preventDefault();if(o.dataTransfer&&o.dataTransfer.files){var e=o.dataTransfer.files[0].type;if(N.includes(e)){if(!localStorage.getItem("hasUploaded")&&!window.confirm("This image will be stored privately on school servers under your account. Continue?")){o.target.parentElement.style.border="5px solid red";return}o.target.parentElement.style.border="5px solid green";let e=new FormData;e.append("upload",o.dataTransfer.files[0]);const n="https://learning.stmichaels.vic.edu.au"+(await te(e)).N.file.D.$;const a=o.target.parentElement.parentElement.parentElement;const t=a.querySelector("td").innerText;I.u[t].$=n;a.style.backgroundImage="url("+n+")";a.style.backgroundSize="100% 100%";localStorage.setItem("extConfig",JSON.stringify(I));await _();localStorage.setItem("hasUploaded",1)}else{o.target.parentElement.style.border="5px solid red"}}},true);for(const $ of document.querySelectorAll("#pronoun-list input")){if(I.k.selected.includes($.name)){$.checked=true}$.addEventListener("change",async function(){if(!$.checked)I.k.selected=I.k.selected.filter(e=>e!=$.name);else if(!I.k.selected.includes($.name))I.k.selected.push($.name);document.getElementById("pronounslabel").innerText="Pronouns: "+I.k.selected.map(e=>D[e]).join(", ");document.getElementById("pronounsrow").innerText=I.k.selected.map(e=>D[e]).join(", ");if(!I.k.selected.length){document.getElementById("pronounslabel").style.setProperty("display","none","important");document.getElementById("pronounsrow").parentNode.style.setProperty("display","none","important")}else{document.getElementById("pronounslabel").style.display="";document.getElementById("pronounsrow").parentNode.style.display=""}I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));await _()})}for(const C of document.querySelectorAll("#pronoun-roles input")){if(I.k.show[parseInt(C.name)]){C.checked=true}C.addEventListener("change",async function(){I.k.show[parseInt(C.name)]=C.checked;I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));await _()})}function w(){m.value=Object.values(I.u).map(e=>{if(e["current"]==="color"){return e["color"]}}).filter(e=>e!==undefined).map(e=>{return L(...e.replace(/[^\d\s]/g,"").split(" ").map(Number))}).join("-").replaceAll("#","").toUpperCase()}w();for(const O of document.querySelectorAll(".subject-color-row")){const v=O.children[0].innerText;if(!O.children[1])continue;O.children[1].children[0].children[0].addEventListener("change",async function(e){const t="rgb("+E(e.target.value)+")";O.style.borderLeft="7px solid "+t;O.style.backgroundColor=t.replace("rgb","rgba").replace(")",", 10%)");I.u[v].color=t;I.u[v].current="color";I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));J();w();await _()});O.children[1].children[0].children[1].addEventListener("change",async function(e){const t=e.target.value;let o=t.match(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/g)!==null&&e.target.reportValidity();e.target.style.border=o?"solid green 2px":"solid red 1px";O.querySelector(".invalidurl").style.display=o?"none":"";I.u[v].$=o?t:null;I.u[v].current=o?"image":"color";O.style.backgroundImage=o?"url("+t+")":"";O.style.backgroundSize="100% 100%";I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));await _();setTimeout(function(){e.target.style.border=""},5e3)});O.children[2].children[0].addEventListener("click",async function(){const e=I.m[v].color;O.style.borderLeft="7px solid "+e;O.style.backgroundColor=e.replace("rgb","rgba").replace(")",", 10%)");O.style.backgroundImage="";O.style.backgroundSize="100% 100%";O.children[1].children[0].children[0].value=L(...e.replace(/[^\d\s]/g,"").split(" ").map(Number));O.children[1].children[0].children[1].value="";I.u[v]={color:e,$:null,current:"color"};I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));J();w();await _()});O.children[3].children[0].addEventListener("click",async function(){I.u[v]["current"]="image";I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));O.children[1].children[0].children[0].style.display="none";O.children[1].children[0].children[1].style.display="";O.style.backgroundImage="url("+I.u[v]["$"]+")";O.style.backgroundSize="100% 100%";O.children[3].children[0].style.display="none";O.children[3].children[1].style.display="";await _()});O.children[3].children[1].addEventListener("click",async function(){I.u[v]["current"]="color";I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));O.children[1].children[0].children[0].style.display="";O.children[1].children[0].children[1].style.display="none";O.style.backgroundColor=I.u[v].color.replace("rgb","rgba").replace(")",", 10%)");O.style.backgroundImage="";O.children[3].children[0].style.display="";O.children[3].children[1].style.display="none";O.querySelector(".invalidurl").style.display="none";await _()})}b.addEventListener("change",async function(e){let t=e.target.value.split("-");let o=Object.assign({},I.m);console.log(e.target);localStorage.setItem("currentTheme",b.options[b.selectedIndex].text);let n=0;for(subjectcode in o){o[subjectcode]={color:"rgb("+E(t[n])+")",$:null,current:"color"};n++;if(n>=t.length){n=0}}I.u=o;I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));await _();window.location.reload()});h.addEventListener("click",function(){h.innerText="Copied!";if(navigator.userAgent.match(/ipad|iphone/i)){Clipboard.C(m.value)}else{m.select();document.execCommand("copy")}setTimeout(()=>{h.innerText="Export"},1e3)});g.addEventListener("click",async function(){if(!p.value){return}let e=I.m;const t=X(p.value);if(t.length==0){g.parentElement.insertAdjacentHTML("afterend",`<div data-alert class="alert-box alert themecodealert"><strong>Invalid Input:</strong> Ensure the text you enter is a list of hex codes seperated by dashes or a coolors.co link.<br><br>For example: "d9ed92-b5e48c-99d98c-76c893-52b69a-34a0a4"</div>`);setTimeout(function(){document.querySelector(".themecodealert")?.remove()},6e3);return}let o=0;for(subjectcode in e){e[subjectcode]={color:t[o],$:null,current:"color"};o++;if(o>=t.length){o=0}}I.u=e;I.updated=Date.now();localStorage.setItem("extConfig",JSON.stringify(I));await _();window.location.reload()});f.addEventListener("click",async function(){if(!confirm("Reset: This will reset all your theme colours and settings back to default, are you sure you want to do this?"))return;I=M;await P(true);window.location.reload()});p.addEventListener("keyup",function(){if(!p.value){g.classList="button disabled"}else{g.classList="button"}})}function q(){if(!document.querySelector(".event-container span.fc-event-title")!==null&&document.querySelector("span[recoloured]")!==null)return;y();for(const e of document.querySelectorAll(".event-container span.fc-event-title")){e.setAttribute("recoloured",1);const t=r.exec(e.innerText)[1]?.split(",");if(!t)continue;for(const o of t){const n=I.u[o]?.color;if(!n){continue}const a=v(L(...n.replace(/[^\d\s]/g,"").split(" ").map(Number)).toUpperCase());e.parentNode.style.backgroundColor=n;for(const i of e.parentNode.children){i.style.color=a}}}}function k(){if(document.querySelector("div[id='calender']")&&document.querySelector("div[id='calender']").querySelector("div.empty-state > p").textContent==="There are no upcoming calendar events")return;if(document.querySelectorAll(".fc-list-event").length===0){setTimeout(k,500);return}document.querySelectorAll(".fc-list-event").forEach(e=>{const t=e.querySelector(".fc-list-event-dot");t.style.backgroundColor=t.style.borderColor;const o=r.exec(e.querySelector(".fc-event-title").innerText);if(!o)return;const n=I.u[o[1]]?.color;if(!n)return;t.style.borderColor=n;t.style.backgroundColor=n})}function Z(){for(const t of document.querySelectorAll(".activity-list")){if(!t.querySelector(".no-margin")){continue}if(!t.querySelector(".flex-grade")){continue}if(c.some(e=>t.querySelector(".no-margin").innerText.includes(e))){t.querySelector(".flex-grade").innerHTML+=`<div class="grade gradient-10-bg no-margin"><span>Click to view feedback</span></div>`}}const o=parseInt(document.querySelector(".card a p.meta")?.innerText.replace(/\D/g,""));if(!isNaN(o)){const n=(new Date).getFullYear();let e=n;let t=n-(o-12+5);if(o<=6||o>12){e+=1;t=e}if(o==12){e-=1}if(t<2021){t=2021}for(summary of document.querySelectorAll("select#context-selector-semester option[value]")){if(summary.innerText.includes("Summary")&&!(parseInt(summary.value)>=t&&parseInt(summary.value)<=e)){summary.style.display="none"}}}for(const t of document.querySelectorAll("ul.activity-list")){const e=t.querySelector(".subject-group span.meta")?.innerText.replace("), (",",");if(!e)continue;if(r.exec(e)[1]){const a=r.exec(e)[1]?.split(",");for(const i of a){const s=I.u[i]?.color;if(!s){continue}t.style.borderLeft="7px solid "+s;t.style.backgroundColor=s.replace("rgb","rgba").replace(")",", 10%)");t.children[0].style.backgroundColor=s.replace("rgb","rgba").replace(")",", 10%)");t.children[1].style.backgroundColor=s.replace("rgb","rgba").replace(")",", 10%)")}}}}function G(){let t=document.querySelectorAll(".subheader");for(e of t){if(!["SUBMIT RESPONSE","SUBMISSION HISTORY"].includes(e.innerText))continue;let t=document.querySelector(".breadcrumb")?.innerText.match(r);let o=document.querySelector(".breadcrumb")?.innerText.match(i);let n=t?t[0]:o[0];if(7<=parseInt(n.slice(1,3))&&parseInt(n.slice(1,3))<=11){const a=document.querySelectorAll(".row");a[a.length-1].insertAdjacentHTML("beforeend",`<div class="small-12 island">
                <section style="text-align: center; padding-bottom: 10px">
                    <img src="${u}">
                </section>
            </div>`)}break}}function Y(){const e=document.querySelector(".fc-button-group .fc-button-active").innerText;if(e=="List"){k()}else{document.querySelectorAll(".fc-timegrid-event, .fc-daygrid-event").forEach(e=>{const t=r.exec(e.innerText);if(!t)return;const o=I.u[t[1]]?.color;if(!o)return;const n=v(L(...o.replace(/[^\d\s]/g,"").split(" ").map(Number)).toUpperCase());e.style.backgroundColor=o;e.querySelectorAll("*").forEach(e=>{e.style.color=n})})}if(e=="Month"){for(const t of document.querySelectorAll("div.fc-popover-body .fc-daygrid-event:not([recoloured])")){const o=r.exec(t.innerText);if(!o)continue;const n=I.u[o[1]]?.color;if(!n)continue;const a=v(L(...n.replace(/[^\d\s]/g,"").split(" ").map(Number)).toUpperCase());t.style.backgroundColor=n;t.querySelectorAll("*").forEach(e=>{e.style.color=a});t.setAttribute("recoloured",1)}}}async function K(){if(!document.querySelector("h2[data-timetable-header]")){fetch("https://services.stmichaels.vic.edu.au/dwi.cfm?otype=json").then(e=>e.json()).then(e=>document.querySelector(".island").insertAdjacentHTML("afterbegin",`<h2 class="subheader">${e.text}</h2>`))}if(I.g.v){const o=document.querySelectorAll(".timetable th, .show-for-small-only th");const n=document.querySelectorAll(".timetable td, .show-for-small-only td");for(let e=0;e<o.length;e++){if(!l.includes(o[e].childNodes[0].textContent.trim())&&!n[e].textContent.trim()){o[e].remove();n[e].remove()}}}(document.querySelector(".awardsComponent")||document.querySelector("#component62394"))?.insertAdjacentHTML("afterend",`
    <style>
        .PTVIcon .line-pill .route-lock-up {
            display: inline-block;
            padding-right: 5px;
            padding-left: 2px;
            height: 28px;
            border: 2px solid;
            border-radius: 100px;
            display: -webkit-inline-box; display: -webkit-inline-flex; display: -ms-inline-flexbox; display: inline-flex;
            -webkit-box-align: center; -webkit-align-items: center; -ms-flex-align: center; align-items: center;
            box-sizing: border-box;
        }
        .PTVIcon .line-pill .route-lock-up span {
            -webkit-box-flex: 1; -webkit-flex: 1 0 auto; -ms-flex: 1 0 auto; flex: 1 0 auto;
            padding-right: 3px;
            display: -webkit-box; display: -webkit-flex; display: -ms-flexbox; display: flex;
            -webkit-box-align: center; -webkit-align-items: center; -ms-flex-align: center; align-items: center;
            height: 100%;
        }
        .PTVIcon .line-pill .route-lock-up .icon {
            width: 21px;
            height: 21px;
        }
        .PTVIcon .direction-title {
            font-weight: 700;
            font-size: 13px;
            padding-left: 3px;
            margin: 0;
        }
        .PTVIcon.time .line-pill .route-lock-up {
            border: 0;
            padding: 0 9px 0 5px;
            border-radius: 100px;
            -webkit-box-align: center; -webkit-align-items: center; -ms-flex-align: center; align-items: center;
            font-weight: 600;
            -webkit-box-sizing: content-box; box-sizing: content-box;
            text-align: left;
        }

        .PTVIcon.tram .route-lock-up {
            border-color: #78be20 !important;
        }
        .PTVIcon.tram .icon {
            background-image: url("https://www.ptv.vic.gov.au/resources/themes/ptv-mpw/public/images/icons/tram.png");
            background-image: url("https://www.ptv.vic.gov.au/resources/themes/ptv-mpw/public/images/icons/tram.svg");
        }

        .PTVIcon.train .route-lock-up {
            border-color: #0072ce !important;
        }
        .PTVIcon.train .icon {
            background-image: url("https://www.ptv.vic.gov.au/resources/themes/ptv-mpw/public/images/icons/train.png");
            background-image: url("https://www.ptv.vic.gov.au/resources/themes/ptv-mpw/public/images/icons/train.svg");
        }
    </style>
    <div class="component-container">
        <div class="row">
            <div class="small-12 island">
                <h2 class="subheader">Public Transport Nearby</h2>
                <section id="ptvDepartures"></section>
            </div>
        </div>
    </div>`);let i;let s;async function t(){if(f===false)return;let e="";i=true;const t=await(await fetch(`${d}/ptv/schedule`)).json();s=t.expires;for(const o of t.M.sort((e,t)=>{return e.I==t.I?0:e.I<t.I?1:-1})){const n=new Date(o.L[0]?.P);const a=Math.ceil((o.L[0]?.P-(new Date).getTime())/1e3);e+=`
                <li style="border-left: 15px solid ${o.J};">
                    <div class="card small-12" data-equalizer style="position: relative; padding-bottom: 8px;">
                        <div>
                            <div style="display: inline; float: left" class="PTVIcon ${o.type==0?"train":"tram"}">
                                <span class="line-pill">
                                    <div class="route-lock-up">
                                        <i class="icon"></i>
                                        <p class="direction-title">${o.I}</p>
                                    </div>
                                </span>
                            </div>
                            <div style="display: inline"><h3 style="padding-left: 10px"><a class="title">${o.prefix}to ${o.name}</a></h3></div>
                        </div>
                        ${o.L.length==0?`<p style="margin-top: 10px">No more scheduled departures today</p>`:`
                            <p style="margin-top: 10px">
                                Scheduled <strong>${n.toLocaleString("en-AU",{hour:"numeric",minute:"2-digit"})}</strong>${o.L.length>1?", ":""}
                                ${o.L.slice(1,4).map(e=>new Date(e.P).toLocaleString("en-AU",{hour:"numeric",minute:"2-digit"})).join(", ")}
                                <span class="meta" style="margin-left: 10px">${o.L[0].platform!==null?"Platform "+o.L[0].platform:"&nbsp"}
                            </p>
                            <div style="position: absolute; top: 50%; right: 15px; transform: translate(0, -50%);" class="PTVIcon time">
                                <span class="line-pill">
                                    <div class="route-lock-up" style="background: rgba(${a<20?"0, 206, 37, 0.25":"0, 114, 206, "+(.35-(a/900>1?1:a/900)*.3)});">
                                        <p class="direction-title" time="${n}">${a<20?"Now":a<3600?`${Math.ceil(a/60)} ${Math.ceil(a/60)==1?"min":"mins"}`:`${Math.ceil(a/3600)} ${Math.ceil(a/3600)==1?"hour":"hours"}`}</p>
                                    </div>
                                </span>
                            </div>
                        `}
                    </div>
                </li>
            `}document.getElementById("ptvDepartures").innerHTML=`<ul class="information-list">${e}</ul>`;i=false}window.addEventListener("focus",function(e){f=true},false);window.addEventListener("blur",function(e){f=false},false);function e(){if(i)return;if(s<(new Date).getTime())return t();for(const e of document.querySelectorAll(".direction-title[time]")){seconds_diff=Math.ceil((new Date(e.getAttribute("time"))-(new Date).getTime())/1e3);if(seconds_diff<0)return t();e.innerText=`${seconds_diff<20?"Now":seconds_diff<3600?`${Math.ceil(seconds_diff/60)} ${Math.ceil(seconds_diff/60)==1?"min":"mins"}`:`${Math.ceil(seconds_diff/3600)} ${Math.ceil(seconds_diff/3600)==1?"hour":"hours"}`}`;e.parentNode.style.background=`rgba(${seconds_diff<20?"0, 206, 37, 0.25":"0, 114, 206, "+(.35-(seconds_diff/900>1?1:seconds_diff/900)*.3)})`}}t();setInterval(t,6e4);setInterval(e,1e3);document.querySelectorAll(".show-for-small-only").forEach(e=>{e.style.backgroundColor="#FFF"});k()}function ee(){document.querySelector("h1[data-timetable-title]").style.display="inline-block";document.querySelector("h1[data-timetable-title]").insertAdjacentHTML("afterend",`
        <a href="/settings/messages" class="button show-for-landscape" style="margin-top: 10px; float: right; display: inline-block">Customise Colours</a>
        <a href="/settings/messages" class="button show-for-portrait" style="margin-top: 10px; display: inline-block">Customise Colours</a>
    `);if(I.g.v){const e=document.querySelectorAll(".timetable tbody tr");for(const n of e){if(!l.includes(n.querySelector("th").childNodes[0].textContent.trim())){hassubject=false;for(const a of n.querySelectorAll("td")){if(a.innerText!=="\n"&&a.children[0].children.length>0){hassubject=true;break}}if(!hassubject){n.style.display="none"}}}const t=document.querySelectorAll(".show-for-small-only th");const o=document.querySelectorAll(".show-for-small-only td");for(let e=0;e<t.length;e++){if(!l.includes(t[e].childNodes[0].textContent.trim())&&!o[e].textContent.trim()){t[e].remove();o[e].remove()}}}}async function S(){return new Promise(async(e,t)=>{try{const n=await fetch(s);if(!n.ok){throw new Error(`Server error (${n.status})`)}else{const a=await n.json();localStorage.setItem("userToken",a._);e()}}catch(o){t(new Error("Network error"))}})}function te(e){return new Promise(t=>{fetch("https://learning.stmichaels.vic.edu.au/storage/asyncUpload.php",{method:"POST",body:e}).then(async e=>{t(await e.json())})})}async function oe(){return new Promise(t=>{fetch(d+"/themes").then(e=>e.json()).then(e=>{t(e)})})}async function T(){return new Promise(async(e,t)=>{try{if(!localStorage.getItem("userToken")){await S()}const n=await fetch(d+"/config",{headers:new Headers({O:"Basic "+localStorage.getItem("userToken")})});if(!n.ok){if(n.status===403){t(new Error("Forbidden"))}else{t(new Error(`Server error (${n.status})`))}}else{const a=await n.json();e(a)}}catch(o){t(new Error("Network error"))}})}async function _(){return new Promise(async t=>{if(!localStorage.getItem("userToken")){await S()}fetch(d+"/config",{method:"POST",headers:new Headers({O:"Basic "+localStorage.getItem("userToken"),H:"application/json"}),body:JSON.stringify({j:I,A:schoolboxUser})}).then(e=>{t()})})}if(!(localStorage.getItem("disableQOL")!=undefined&&typeof forceEnableQOL=="undefined")){const C=["Ducks are pretty cool","More themes one day???","Cubifying dogs, 50% loaded","Good4u (subscribe)","Boppity bibbity your breathing is now a concious activity","Here you leave the world of today, and enter the world of yesterday, tomorrow, and fantasy ",":D","Hello there","General kenobi","Over 1.8k lines of code!","We would like to contact your about your cars extended warranty","As seen on TV!","It's here!","One of a kind!","Mobile compatible!","Exclusive!","NP is not in P!","Jeb_","Also try services!","There are no facts, only interpretations.","Made with CSS!","Made with JS!","0% Sugar!"];const O=Math.floor(Math.random()*C.length);const H=C[O];console.log("Schol Extensions Enabled. "+H)}
